<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MiniChat</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>

  <body class="container mx-auto py-4">
    <div
      class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-sm border border-gray-100"
    >
      <div class="mb-6">
        <h1 class="text-xl font-bold text-gray-800 tracking-tight">MiniChat</h1>
        <div class="h-1 w-10 bg-violet-500 mt-2 rounded-full"></div>
      </div>

      <form id="miFormulario" class="relative">
        <div class="flex items-center gap-3">
          <div class="relative flex-1">
            <input
              type="text"
              id="txtMensaje"
              placeholder="Escribe tu mensaje aquí..."
              class="w-full pl-4 pr-4 py-3 bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-lg focus:ring-2 focus:ring-violet-500 focus:border-violet-500 block transition-all duration-200 outline-none"
            />
          </div>

          <button
            type="submit"
            class="bg-violet-600 hover:bg-violet-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg focus:ring-4 focus:ring-violet-300"
          >
            Enviar
          </button>
        </div>
      </form>

      <div
        id="misMensajes"
        class="h-80 overflow-y-auto p-6 space-y-4 bg-white scroll-smooth"
      >
        <div
          class="text-center text-gray-400 text-sm mt-20 italic opacity-50"
          id="mensaje-bienvenida"
        >
          El historial de mensajes aparecerá aquí...
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"
      integrity="sha512-8BHxHDLsOHx+flIrQ0DrZcea7MkHqRU5GbTHmbdzMRnAaoCIkZ97PqZcXJkKZckMMhqfoeaJE+DNUVuyoQsO3Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script>
      //Socket del lado del cliente
      const socket = io();

      //Referencias al elemento del DOM
      const miFormulario = document.querySelector("#miFormulario")
      const mensajes = document.querySelector('#misMensajes');
      const txtMensaje = document.querySelector('#txtMensaje')
      const mensajeBienvenida = document.querySelector("#mensaje-bienvenida")
      let htmlMensaje = "";
      let nombreUsuario = ""

      document.addEventListener('DOMContentLoaded', function () {
        alert('¡El HTML está listo!');
      });
      miFormulario.addEventListener('submit', (ev) => {
        ev.preventDefault();

        const nuevoMensaje = txtMensaje.value;

        //Envia el mensaje al servidor
        socket.emit('mensaje-a-servidor', nuevoMensaje);
        miFormulario.reset(); //Limpia el formulario

      })
      // Recibir el historial de mensajes cuando se conecta
      socket.on('historial-mensajes', (historial) => {
        if (historial.length > 0) {
          if (mensajeBienvenida) {
            mensajeBienvenida.remove();
          }
          
          historial.forEach((data) => {
            const htmlMensaje = `
              <div class="animate-fade-in-up">
                <div class="inline-block bg-violet-100 text-violet-900 px-4 py-2 rounded-lg rounded-tl-none shadow-sm max-w-[80%]">
                  <p class="font-medium text-sm">Usuario</p>
                  <p>${data.msg}</p>
                </div>
                <span class="text-xs text-gray-400 ml-2">${moment(data.fecha).format("LT")}</span>
              </div>`;
            mensajes.innerHTML += htmlMensaje;
          });
          
          mensajes.scrollTop = mensajes.scrollHeight;
        }
      });

      //El mensaje se visualiza por pantalla
      socket.on('mensaje-desde-servidor', (data) => {

        if (mensajeBienvenida) {
          mensajeBienvenida.remove();
        }

        htmlMensaje = `
            <div class="animate-fade-in-up">
              <div class="inline-block bg-violet-100 text-violet-900 px-4 py-2 rounded-lg rounded-tl-none shadow-sm max-w-[80%]">
                <p class="font-medium text-sm">Usuario</p>
                <p>${data.msg}</p>
              </div>
              <span class="text-xs text-gray-400 ml-2">${moment(data.fecha).format("LT")}</span>
            </div> `
        mensajes.innerHTML += htmlMensaje;
        mensajes.scrollTop = mensajes.scrollHeight;


      })
    </script>
  </body>
</html>
